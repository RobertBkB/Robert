<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
  <title>Zustandsdiagramm mit Punkt A</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    canvas {
      border: 1px solid #ccc;
    }
    .controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .button-row {
      display: flex;
      gap: 10px;
    }
    button {
      font-size: 1.2em;
      padding: 10px 15px;
    }
  </style>
</head>
<body>

  <h1>Kristallgemische</h1>
  <select id="materialSelect" onchange="wechselMaterial()" style="width: 100%; max-width: 400px;">
    <option value="Pb-Sn">Blei (Pb) – Zinn (Sn) Eutektikum: 61,9%Pb, 183°C</option>
    <option value="Al-Si">Aluminium (Al) – Silizium (Si) Eutektikum: 12,6%Al, 577°C</option>
    <option value="Cu-Sb">Kupfer (Cu) – Antimon (Sb) Eutektikum: 90%Cu, 630°C</option>
  </select>

  <!-- Diagramm -->
  <canvas id="diagramm" width="600" height="400"></canvas>

  <!-- Steuerung -->
  <div class="controls">
    <div>
      <strong>Temperatur</strong>
      <div class="button-row">
        <button onclick="ändereTemperatur(5)">⬆️</button>
        <button onclick="ändereTemperatur(-5)">⬇️</button>
        <button onclick="ändereZusammensetzung(-1)">⬅️</button>
        <button onclick="ändereZusammensetzung(1)">➡️</button>
      </div>
    </div>
  </div>

  <!-- Kuchendiagramm -->
  <canvas id="kuchen" width="300" height="300"></canvas>

  <script>
    const canvas = document.getElementById("diagramm");
    const ctx = canvas.getContext("2d");
    const pieCanvas = document.getElementById("kuchen");
    const pieCtx = pieCanvas.getContext("2d");

    const materialSysteme = {
      "Pb-Sn": {
        name: "Blei-Zinn",
        elements: { A: "Pb", B: "Sn" },
        eutektikum: { comp: 61.9, temp: 183 },
        getLiquidusTemp: (x) => x <= 61.9 ? 327 - (327 - 183) * (x / 61.9) : 183 + (x - 61.9) / (100 - 61.9) * (327 - 183),
        getSolidusTemp: () => 183,
        tempMin: 100,
        tempMax: 350
      },
      "Al-Si": {
        name: "Aluminium-Silizium",
        elements: { A: "Al", B: "Si" },
        eutektikum: { comp: 12.6, temp: 577 },
        getLiquidusTemp: (x) => x <= 12.6 ? 660 - (660 - 577) * (x / 12.6) : 577 + (x - 12.6) / (100 - 12.6) * (660 - 577),
        getSolidusTemp: () => 577,
        tempMin: 500,
        tempMax: 700
      },
      "Cu-Sb": {
        name: "Kupfer-Antimon",
        elements: { A: "Cu", B: "Sb" },
        eutektikum: { comp: 90, temp: 630 },
        getLiquidusTemp: (x) => x <= 90 ? 1085 - (1085 - 630) * (x / 90) : 630 + (x - 90) / (100 - 90) * (1085 - 630),
        getSolidusTemp: () => 630,
        tempMin: 500,
        tempMax: 1150
      }
    };

    let aktuellesSystem = materialSysteme["Pb-Sn"];
    let eutektikum = aktuellesSystem.eutektikum;
    let comp = eutektikum.comp;
    let temp = eutektikum.temp;

    
    function wechselMaterial() {
      const auswahl = document.getElementById("materialSelect").value;
      aktuellesSystem = materialSysteme[auswahl];
      eutektikum = aktuellesSystem.eutektikum;
      comp = eutektikum.comp;
      temp = eutektikum.temp;
      update();
    }

    function ändereTemperatur(delta) {
        temp += delta;
        temp = Math.max(aktuellesSystem.tempMin, Math.min(aktuellesSystem.tempMax, temp));
        update(); // ✅ Aufruf der globalen update-Funktion
    }

    function ändereZusammensetzung(delta) {
        comp += delta;
        comp = Math.max(0, Math.min(100, comp));
    update();
    }


function update() {
  const eutektikum = aktuellesSystem.eutektikum;

  let solid = 0, liquid = 0;
  let solidComp = comp, liquidComp = comp;
  const liquidusTemp = aktuellesSystem.getLiquidusTemp(comp);
  const solidusTemp = aktuellesSystem.getSolidusTemp(comp);

  let festA = 0, festB = 0, festE = 0;

  if (temp > liquidusTemp) {
    // vollständig flüssig
    liquid = 100;
    solid = 0;
    liquidComp = comp;
    solidComp = 0;
  } else if (temp < solidusTemp) {
    // vollständig fest
    solid = 100;
    liquid = 0;

    if (comp < eutektikum.comp) {
      festE = (100 * comp) / eutektikum.comp;
      festA = 100 - festE;
      festB = 0;
    } else if (comp > eutektikum.comp) {
      festE = (100 * (100 - comp)) / (100 - eutektikum.comp);
      festB = 100 - festE;
      festA = 0;
    } else {
      festE = 100;
      festA = 0;
      festB = 0;
    }

    solidComp = (festB * 100 + festE * eutektikum.comp) / (festA + festB + festE);
    liquidComp = 0;
  } else {
    // Zweiphasengebiet: fest + flüssig
    liquid = (temp - solidusTemp) / (liquidusTemp - solidusTemp) * 100;
    solid = 100 - liquid;

    // feste Phase ist konstant
    if (comp < eutektikum.comp) {
      solidComp = 0; // reines Pb
    } else if (comp > eutektikum.comp) {
      solidComp = 100; // reines Sn
    } else {
      solidComp = eutektikum.comp; // eutektisch
    }

    // flüssige Phase liegt auf Liquiduslinie → berechne rückwärts
    if (comp < eutektikum.comp) {
      liquidComp = 61.9 * (327 - temp) / (327 - 183);
    } else {
      liquidComp = 61.9 + (temp - 183) / (327 - 183) * (100 - 61.9);
    }

    // keine Festphasenanteile anzeigen im Zweiphasengebiet
    festA = 0;
    festB = 0;
    festE = 0;
  }

  // Relativierung für Kuchendiagramm
  const sumFest = festA + festB + festE;
  let festA_rel = 0, festB_rel = 0, festE_rel = 0;
  if (sumFest > 0) {
    festA_rel = festA / sumFest * 100;
    festB_rel = festB / sumFest * 100;
    festE_rel = festE / sumFest * 100;
  }

  drawDiagram(comp, temp, solid, liquid, solidComp, liquidComp, festA_rel, festB_rel, festE_rel);
  drawPie(solid, liquid, solidComp, liquidComp, festA_rel, festB_rel, festE_rel);
}



function drawPie(solid, liquid, solidComp, liquidComp, festA, festB, festE) {
  pieCtx.clearRect(0, 0, pieCanvas.width, pieCanvas.height);
  const centerX = pieCanvas.width / 2;
  const centerY = pieCanvas.height / 2;
  const radius = 100;

  const segmente = [
    { label: "Fest A", value: festA, color: "#3498db" },
    { label: "Fest B", value: festB, color: "#e74c3c" },
    { label: "Fest E", value: festE, color: "#f1c40f" },
    { label: "Flüssig", value: liquid, color: "#2ecc71" }
  ];

  let startAngle = 0;
  segmente.forEach(seg => {
    const sliceAngle = (seg.value / 100) * 2 * Math.PI;
    pieCtx.beginPath();
    pieCtx.moveTo(centerX, centerY);
    pieCtx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
    pieCtx.closePath();
    pieCtx.fillStyle = seg.color;
    pieCtx.fill();
    startAngle += sliceAngle;
  });

  pieCtx.fillStyle = "#000";
  pieCtx.font = "14px Arial";
  pieCtx.textAlign = "center";
  pieCtx.fillText(`T: ${Math.round(temp)}°C`, centerX, centerY - radius - 10);
  pieCtx.fillText(`C: ${Math.round(comp)}%`, centerX, centerY - radius + 10);
}
function drawDiagram(comp, temp, solid, liquid, solidComp, liquidComp, festA_rel, festB_rel, festE_rel) {
  const yMin = aktuellesSystem.tempMin;
  const yMax = aktuellesSystem.tempMax;
  const yScale = (yMax - yMin) / 300;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Achsen
  ctx.beginPath();
  ctx.moveTo(50, 350);
  ctx.lineTo(550, 350);
  ctx.moveTo(50, 350);
  ctx.lineTo(50, 50);
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 1;
  ctx.stroke();

  // Achsenbeschriftung
  ctx.font = "12px Arial";
  ctx.fillStyle = "#000";
  ctx.textAlign = "center";
  for (let c = 0; c <= 100; c += 10) {
    const xPos = 50 + c * 5;
    ctx.fillText(`${c}%`, xPos, 365);
    ctx.beginPath();
    ctx.moveTo(xPos, 350);
    ctx.lineTo(xPos, 355);
    ctx.stroke();
  }

  ctx.textAlign = "right";
  for (let t = yMin; t <= yMax; t += 50) {
    const yPos = 350 - (t - yMin) / yScale;
    ctx.fillText(`${t}°C`, 45, yPos + 4);
    ctx.beginPath();
    ctx.moveTo(45, yPos);
    ctx.lineTo(50, yPos);
    ctx.stroke();
  }

  // Liquiduslinie (vollständig)
  ctx.beginPath();
  for (let c = 0; c <= 100; c++) {
    const x = 50 + c * 5;
    const y = 350 - (aktuellesSystem.getLiquidusTemp(c) - yMin) / yScale;
    if (c === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.strokeStyle = "red";
  ctx.stroke();

  // Soliduslinie (isotherm)
  ctx.beginPath();
  for (let c = 0; c <= 100; c++) {
    const x = 50 + c * 5;
    const y = 350 - (aktuellesSystem.getSolidusTemp(c) - yMin) / yScale;
    if (c === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.strokeStyle = "blue";
  ctx.stroke();

  // Punkt A
  const x = 50 + comp * 5;
  const y = 350 - (temp - yMin) / yScale;
  ctx.beginPath();
  ctx.arc(x, y, 6, 0, 2 * Math.PI);
  ctx.fillStyle = "green";
  ctx.fill();
  ctx.strokeStyle = "black";
  ctx.stroke();

  const textOffsetX = x > 450 ? -10 : 10;
  const textAlign = x > 450 ? "right" : "left";
  ctx.save();
  ctx.textAlign = textAlign;
  ctx.fillStyle = "#000";
  ctx.font = "12px Arial";
  ctx.fillText(`S ${Math.round(liquid)}% (${aktuellesSystem.elements.A} ${(100 - liquidComp).toFixed(0)}%, ${aktuellesSystem.elements.B} ${liquidComp.toFixed(0)}%)`, x + textOffsetX, y + 15);
 if (solid === 100) {
  ctx.fillText(`F ${Math.round(solid)}% (${aktuellesSystem.elements.A} ${festA_rel.toFixed(0)}%, ${aktuellesSystem.elements.B} ${festB_rel.toFixed(0)}%, E ${festE_rel.toFixed(0)}%)`, x + textOffsetX, y + 30);
} else {
  ctx.fillText(`F ${Math.round(solid)}% (${aktuellesSystem.elements.A} ${(100 - solidComp).toFixed(0)}%, ${aktuellesSystem.elements.B} ${solidComp.toFixed(0)}%)`, x + textOffsetX, y + 30);
}

  ctx.fillText(`T ${Math.round(temp)}°C`, x + textOffsetX, y + 45);
  ctx.textAlign = "center";
ctx.fillText(`Element: ${aktuellesSystem.elements.B}`, canvas.width / 2, 385);

  ctx.restore();
}
   wechselMaterial(); // Initialer Aufruf
  </script>
</body>
</html>
